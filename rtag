#!/bin/sh
set -eu

. ./xparse/xparse.sh

_TB="$(printf "\t")"
_NL="$(printf "\nx")"
_NL="${_NL%x}"

IFS=

# Args: root dir
build_cache() {
    # {{{
    local ROOT_DIR="${1}"

    # Assumptions:
    # - filenames DON'T contain newlines
    # - tags DON'T contain tabs
    # - tags DON'T contain newlines
    #
    # I think the above assumptions are reasonable, but they can always be
    # escaped later if needed.

    local TAGS_FILE
    IFS=

    find "${ROOT_DIR}" -iname '*.tags' -size '+0' | \
        sed -e 's/\\/\\\\/g' \
            -e 's/\t/\\t/g' | \
        while read -r TAGS_FILE; do
            local FILE="${TAGS_FILE%.tags}"
            [ -e "${FILE}" ] || continue

            # Filename
            printf "%s\t" "${FILE}"

            # Tags separated with tabs
            cat "${TAGS_FILE}" | \
                sed -e '/^$/d' | \
                tr '\n' '\t' | \
                sed -e 's/\t$/\n/'
        done
} # }}}

do_build_cache() { build_cache "${1}"; }

xparse_add_option  "build_cache"  1  do_build_cache
xparse_add_option  "b"            1  do_build_cache

xparse_execute_args "$@"
